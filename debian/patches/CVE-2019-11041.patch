From f22101c8308669bb63c03a73a2cac2408d844f38 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sun, 7 Jul 2019 17:01:01 -0700
Subject: [PATCH] Fix bug #78222 (heap-buffer-overflow on exif_scan_thumbnail)

(cherry picked from commit dea2989ab8ba87a6180af497b2efaf0527e985c5)
---
 NEWS                         |   4 ++++
 ext/exif/exif.c              |   2 +-
 ext/exif/tests/bug78222.jpg  | Bin 0 -> 91 bytes
 ext/exif/tests/bug78222.phpt |  11 +++++++++++
 4 files changed, 16 insertions(+), 1 deletion(-)
 create mode 100644 ext/exif/tests/bug78222.jpg
 create mode 100644 ext/exif/tests/bug78222.phpt

#diff --git a/NEWS b/NEWS
#index 6dba597..8a3e4a5 100644
#--- a/NEWS
#+++ b/NEWS
#@@ -2,6 +2,10 @@ PHP                                                                        NEWS
# |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ?? ??? ????, PHP 7.3.8
# 
#+- EXIF:
#+  . Fixed bug #78222 (heap-buffer-overflow on exif_scan_thumbnail).
#+    (CVE-2019-11041) (Stas)
#+
# - OPcache:
#   . Fixed bug #78341 (Failure to detect smart branch in DFA pass). (Nikita)
# 
Index: php7.2-7.2.19/ext/exif/exif.c
===================================================================
--- php7.2-7.2.19.orig/ext/exif/exif.c
+++ php7.2-7.2.19/ext/exif/exif.c
@@ -3919,7 +3919,7 @@ static int exif_scan_thumbnail(image_inf
 	size_t          length=2, pos=0;
 	jpeg_sof_info   sof_info;
 
-	if (!data) {
+	if (!data || ImageInfo->Thumbnail.size < 4) {
 		return FALSE; /* nothing to do here */
 	}
 	if (memcmp(data, "\xFF\xD8\xFF", 3)) {
Index: php7.2-7.2.19/ext/exif/tests/bug78222.phpt
===================================================================
--- /dev/null
+++ php7.2-7.2.19/ext/exif/tests/bug78222.phpt
@@ -0,0 +1,11 @@
+--TEST--
+Bug #78222 (heap-buffer-overflow on exif_scan_thumbnail)
+--SKIPIF--
+<?php if (!extension_loaded('exif')) print 'skip exif extension not available';?>
+--FILE--
+<?php
+exif_read_data(__DIR__."/bug78222.jpg", 'THUMBNAIL', FALSE, TRUE);
+?>
+DONE
+--EXPECTF--
+DONE
\ No newline at end of file

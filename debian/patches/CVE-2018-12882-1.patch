From 3fdde65617e9f954e2c964768aac8831005497e5 Mon Sep 17 00:00:00 2001
From: "Christoph M. Becker" <cmbecker69@gmx.de>
Date: Sat, 9 Jun 2018 17:52:05 +0200
Subject: [PATCH] Fix #76409: heap use after free in _php_stream_free

We must not close the stream in exif_read_from_impl(), since it is the
responsibility of the (caller's) caller to do so, if it actually opened
the stream.

We simplify the reproduce script, which is actually about supplying a
path to a directory (opposed to a regular file), and use `.` instead of
`/` to also make it work on Windows.
---
 NEWS                         |  3 +++
 ext/exif/exif.c              |  2 +-
 ext/exif/tests/bug76409.phpt | 14 ++++++++++++++
 3 files changed, 18 insertions(+), 1 deletion(-)
 create mode 100644 ext/exif/tests/bug76409.phpt

#diff --git a/NEWS b/NEWS
#index c90330a..bc1b434 100644
#--- a/NEWS
#+++ b/NEWS
#@@ -2,6 +2,9 @@ PHP                                                                        NEWS
# |||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
# ?? ??? ????, PHP 7.2.8
# 
#+- EXIF:
#+  . Fixed bug #76409 (heap use after free in _php_stream_free). (cmb)
#+
# 07 Jun 2018, PHP 7.2.7
# 
# - Core:
diff --git a/ext/exif/exif.c b/ext/exif/exif.c
index f5b0d40..67e827b 100644
--- a/ext/exif/exif.c
+++ b/ext/exif/exif.c
@@ -4324,7 +4324,7 @@ static int exif_read_from_impl(image_info_type *ImageInfo, php_stream *stream, i
 			zend_string *base;
 			if ((st.st_mode & S_IFMT) != S_IFREG) {
 				exif_error_docref(NULL EXIFERR_CC, ImageInfo, E_WARNING, "Not a file");
-				php_stream_close(ImageInfo->infile);
+				ImageInfo->infile = NULL;
 				return FALSE;
 			}
 
diff --git a/ext/exif/tests/bug76409.phpt b/ext/exif/tests/bug76409.phpt
new file mode 100644
index 0000000..8c28011
--- /dev/null
+++ b/ext/exif/tests/bug76409.phpt
@@ -0,0 +1,14 @@
+--TEST--
+Bug #76409 (heap use after free in _php_stream_free)
+--SKIPIF--
+<?php
+if (!extension_loaded('exif')) die('skip exif extension not available');
+?>
+--FILE--
+<?php
+exif_read_data('.');
+?>
+===DONE===
+--EXPECTF--
+Warning: exif_read_data(): Not a file in %s on line %d
+===DONE===
-- 
2.1.4

